name: Cleanup stale ah-ho-fruits directory

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete stale directory via FTP
        run: |
          HOST="${{ secrets.VODIEN_HOST }}"
          USER="${{ secrets.VODIEN_USER }}"
          PASS="${{ secrets.VODIEN_PASSWORD }}"

          echo "=== Checking stale directory exists ==="
          curl -s "ftp://$HOST/public_html/ah-ho-fruits/" --user "$USER:$PASS" 2>&1 | head -5

          echo ""
          echo "=== Removing stale directory recursively via FTP ==="

          # Install lftp for recursive FTP operations
          sudo apt-get install -y -qq lftp > /dev/null 2>&1

          # Use lftp to recursively delete the stale directory
          lftp -u "$USER","$PASS" "ftp://$HOST" <<LFTP_SCRIPT
          set ssl:verify-certificate no
          set ftp:ssl-allow yes
          rm -rf public_html/ah-ho-fruits/
          quit
          LFTP_SCRIPT

          echo ""
          echo "=== Verify stale directory is gone ==="
          if curl -s "ftp://$HOST/public_html/ah-ho-fruits/" --user "$USER:$PASS" 2>&1 | grep -q "550\|Access denied\|No such"; then
            echo "SUCCESS: Directory removed"
          else
            echo "WARNING: Directory may still exist, checking contents..."
            curl -s "ftp://$HOST/public_html/ah-ho-fruits/" --user "$USER:$PASS" 2>&1 | head -5
          fi

      - name: Verify site still works
        run: |
          sleep 3
          echo -n "Homepage: "
          curl -sI -o /dev/null -w "%{http_code}" "https://ahhofruit.com"
          echo ""
          echo -n "Shop page: "
          curl -sI -o /dev/null -w "%{http_code}" "https://ahhofruit.com/shop/"
          echo ""
          echo -n "order-fulfillment.php: "
          curl -sI -o /dev/null -w "%{http_code}" "https://ahhofruit.com/wp-content/plugins/ah-ho-custom/includes/order-fulfillment.php"
          echo ""
          echo -n "Fulfillment check API: "
          curl -s "https://ahhofruit.com/wp-json/ah-ho/v1/fulfillment-check"
          echo ""
