name: Cleanup stale ah-ho-fruits directory

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Rename stale directory via FTP
        run: |
          HOST="${{ secrets.VODIEN_HOST }}"
          USER="${{ secrets.VODIEN_USER }}"
          PASS="${{ secrets.VODIEN_PASSWORD }}"

          echo "=== Checking if stale directory exists ==="
          if curl -s "ftp://$HOST/public_html/ah-ho-fruits/" --user "$USER:$PASS" 2>&1 | grep -q "drw\|wp-content"; then
            echo "Stale directory found, renaming..."

            # Rename via FTP RNFR/RNTO commands
            curl -s "ftp://$HOST/public_html/" --user "$USER:$PASS" \
              -Q "RNFR ah-ho-fruits" \
              -Q "RNTO _old_ah-ho-fruits_DELETE_ME" \
              2>&1

            echo ""
            echo "Verifying rename..."
            echo -n "Old path (should fail): "
            curl -s "ftp://$HOST/public_html/ah-ho-fruits/" --user "$USER:$PASS" 2>&1 | head -1
            echo ""
            echo -n "New path (should list): "
            curl -s "ftp://$HOST/public_html/_old_ah-ho-fruits_DELETE_ME/" --user "$USER:$PASS" 2>&1 | head -3
          else
            echo "Stale directory already cleaned up or doesn't exist"
          fi

      - name: Verify site still works
        run: |
          sleep 3
          echo -n "Homepage: "
          curl -sI -o /dev/null -w "%{http_code}" "https://ahhofruit.com"
          echo ""
          echo -n "Shop page: "
          curl -sI -o /dev/null -w "%{http_code}" "https://ahhofruit.com/shop/"
          echo ""
          echo -n "order-fulfillment.php: "
          curl -sI -o /dev/null -w "%{http_code}" "https://ahhofruit.com/wp-content/plugins/ah-ho-custom/includes/order-fulfillment.php"
          echo ""
